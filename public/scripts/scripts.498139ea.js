"use strict";angular.module("chariotApp",["ngAnimate","ngCookies","ngResource","ui.router","ngSanitize","ngTouch"]).config(["$stateProvider","$urlRouterProvider","AccessLevels",function(a,b,c){b.otherwise("/"),a.state("anon",{"abstract":!0,template:"<ui-view/>",data:{access:c.anon}}).state("anon.home",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl"}).state("anon.about",{url:"/about",templateUrl:"views/about.html",controller:"AboutCtrl"}).state("anon.login",{url:"/login",templateUrl:"views/auth/login.html",controller:"LoginCtrl"}).state("anon.register",{url:"/register",templateUrl:"views/auth/register.html",controller:"RegisterCtrl"}).state("user",{"abstract":!0,template:"<ui-view/>",data:{access:c.user}}).state("user.rides",{url:"/rides",templateUrl:"user/rides.html",controller:"RidesCtrl"})}]).run(["$rootScope","$state","Auth",function(a,b,c){a.$on("$stateChangeStart",function(a,d){c.authorize(d.data.access)||(a.preventDefault(),b.go("anon.login"))})}]),angular.module("chariotApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("chariotApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("chariotApp").controller("RidesCtrl",["$scope","$rootScope","RidesService",function(a,b,c){a.geolocation=function(){navigator?(a.positionMessage="Loading...",navigator.geolocation.getCurrentPosition(function(d){b.$apply(function(){a.positionMessage="Latitude: "+d.coords.latitude+" Longitude: "+d.coords.longitude,c.postCoords(d).success(function(){console.log("postCoords returned success")}).error(function(){alert("postCoords ERROR")})})})):b.$apply(function(){a.positionMessage="Geolocation is not supported"})}}]),angular.module("chariotApp").controller("LoginCtrl",["$scope","$state","Auth",function(a,b,c){a.errors=[],a.login=function(){a.loginForm.$valid&&(a.errors=[],c.login(a.user).success(function(){b.go("user.rides")}).error(function(b){a.errors.push(b)}))}}]),angular.module("chariotApp").controller("RegisterCtrl",["$scope","$state","Auth",function(a,b,c){a.register=function(){c.register(a.user).then(function(){b.go("anon.home")})}}]),angular.module("chariotApp").controller("NavCtrl",["$scope","Auth","CurrentUser",function(a,b,c){a.isCollapsed=!0,a.auth=b,a.user=c.user,a.logout=function(){b.logout()}}]),angular.module("chariotApp").service("RidesService",["$http",function(a){this.postCoords=function(b){console.log("postCords called with fullPosition = "+JSON.stringify(b));var c={latitude:b.coords.latitude,longitude:b.coords.longitude};return console.log("sending to server a position = "+JSON.stringify(c)),a.post("/api/rides",{ride:c})}}]),angular.module("chariotApp").constant("AccessLevels",{anon:0,user:1}),angular.module("chariotApp").factory("Auth",["$http","LocalService","AccessLevels",function(a,b,c){function d(b){a.get("/auth/token_status?token="+b)}var e=b.get("auth_token");return e&&(e=angular.fromJSON(b.get("auth_token")).token,d(e)),{authorize:function(a){return a===c.user?this.isAuthenticated():!0},login:function(c){var d=a.post("/auth/authenticate",c);return d.success(function(a){b.set("auth_token",JSON.stringify(a))}),d},logout:function(){b.unset("auth_token")},register:function(c){b.unset("auth_token");var d=a.post("/auth/register",c);return d.success(function(a){b.set("auth_token",JSON.stringify(a))}),d}}}]).factory("AuthInterceptor",["$q","$injector",function(a,b){var c=b.get("LocalService");return{request:function(a){var b;return c.get("auth_token")&&(b=angular.fromJSON(c.get("auth_token")).token),b&&(a.headers.Authorization="Bearer"+b),a},responseError:function(d){return(401===d.status||403===d.status)&&(c.unset("auth_token"),b.get("$state").go("anon.login")),a.reject(d)}}}]).config(["$httpProvider",function(a){a.interceptors.push("AuthInterceptor")}]),angular.module("chariotApp").factory("CurrentUser",["LocalService",function(a){return{user:function(){return a.get("auth_token")?angular.fromJson(a.get("auth_token")).user:{}}}}]),angular.module("chariotApp").factory("LocalService",function(){return{get:function(a){return localStorage.getItem(a)},set:function(a,b){return localStorage.setItem(a,b)},unset:function(a){return localStorage.removeItem(a)}}});